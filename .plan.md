# Frontend Refactor Implementation Plan

## Overview
Transform the trading app from coin-specific chat panels to a universal chat system with authentication, chat history, and natural language symbol detection.

---

## Architecture Decisions

### 1. Auth State Management
**Choice: React Context API + localStorage**
- `AuthContext` provides: `user`, `login()`, `signup()`, `logout()`, `isAuthenticated`
- Tokens stored in localStorage for "Remember me" functionality
- Auto-refresh tokens using interceptor pattern
- Simpler than Zustand for this use case

### 2. API Client Abstraction
**Choice: Axios instance with interceptors**
```typescript
// lib/api-client.ts
- Base URL from env variable
- Request interceptor: Add JWT token to headers
- Response interceptor: Handle 401 (refresh token or redirect to login)
- Error handling: Transform backend errors to user-friendly messages
```

### 3. Chat History Data Structure
**Backend (MongoDB):**
```typescript
{
  _id: ObjectId,
  user_id: string,
  title: string,  // Auto-generated from first message
  messages: [
    {
      role: 'user' | 'assistant',
      content: string,
      timestamp: Date,
      prediction?: PredictionData
    }
  ],
  created_at: Date,
  updated_at: Date,
  is_active: boolean  // Current chat = true
}
```

**Frontend state:**
```typescript
- currentChat: Chat | null
- chatHistory: Chat[]  // List of past chats
- messages: Message[]  // Current chat messages
```

### 4. WebSocket Integration
**Phase 1 (MVP):** Skip WebSockets, use HTTP polling for now
**Phase 2 (Enhancement):** Add Socket.IO for real-time updates

---

## Component Breakdown

### New Components to Create

1. **`LoginPage.tsx`** (`app/login/page.tsx`)
   - Email + password inputs
   - Login button
   - Link to signup page
   - "Remember me" checkbox
   - Error messages

2. **`SignupPage.tsx`** (`app/signup/page.tsx`)
   - Email, password, full name inputs
   - Signup button
   - Link to login page
   - Password strength indicator

3. **`AuthContext.tsx`** (`contexts/AuthContext.tsx`)
   - Manages auth state globally
   - Provides login/signup/logout functions
   - Token refresh logic

4. **`ChatHistorySidebar.tsx`** (`components/ChatHistorySidebar.tsx`)
   - List of past chats
   - "+ New Chat" button
   - Chat search/filter
   - Delete chat option
   - Click to switch chats

5. **`ProtectedRoute.tsx`** (`components/ProtectedRoute.tsx`)
   - Wrapper component
   - Redirects to /login if not authenticated
   - Shows loading spinner while checking auth

6. **`ErrorToast.tsx`** (`components/ErrorToast.tsx`)
   - Toast notification system
   - Success/error/info variants
   - Auto-dismiss after 5s

### Components to Modify

1. **`ChatPanel.tsx`**
   - Remove `selectedSymbol` prop (no longer needed)
   - Update API call to use `apiClient` instead of fetch
   - Add chat history save on each message
   - Load messages from `currentChat` state
   - Handle loading states better
   - Add error handling with toast

2. **`TradingViewChart.tsx`**
   - Change `allow_symbol_change: false` â†’ `true`
   - Remove symbol prop (user selects in widget)
   - Add event listener for symbol changes
   - Update chart when user selects new symbol

3. **`TradePage.tsx`** (`app/trade/page.tsx`)
   - Remove `selectedSymbol` state
   - Add `ProtectedRoute` wrapper
   - Add `ChatHistorySidebar` component
   - Layout: Sidebar (20%) | Chat (30%) | Chart (50%)
   - Add "+ New Chat" button in header

4. **`Header.tsx`** (create if doesn't exist)
   - User profile dropdown
   - Logout button
   - App name/logo

### Components to Delete

1. **`SymbolSelector.tsx`**
   - Completely remove
   - Backend auto-detects symbols from chat
   - TradingView chart has built-in search

---

## Implementation Phases

### Phase 1: Auth System (Priority 1)

**Backend Work:**
- âœ… Auth endpoints already exist (`/api/v1/auth/*`)
- No backend changes needed

**Frontend Work:**
1. Create `AuthContext.tsx`
2. Create `lib/api-client.ts` (axios instance)
3. Create `LoginPage.tsx`
4. Create `SignupPage.tsx`
5. Create `ProtectedRoute.tsx`
6. Wrap `/trade` route with `ProtectedRoute`
7. Add auth token to all API requests

**Files to create:**
- `frontend/src/contexts/AuthContext.tsx`
- `frontend/src/lib/api-client.ts`
- `frontend/src/app/login/page.tsx`
- `frontend/src/app/signup/page.tsx`
- `frontend/src/components/ProtectedRoute.tsx`

**Files to modify:**
- `frontend/src/app/trade/page.tsx` (add ProtectedRoute wrapper)
- `frontend/src/app/layout.tsx` (wrap with AuthProvider)

---

### Phase 2: Chat History Backend (Priority 2)

**Backend Work:**
Create new endpoint: `POST /api/v1/chat/save`
```python
Request: { message: str, response: dict, chat_id?: str }
Response: { chat_id: str, success: bool }
```

Create endpoint: `GET /api/v1/chat/history`
```python
Response: { chats: [{ id, title, created_at, message_count }] }
```

Create endpoint: `GET /api/v1/chat/{chat_id}`
```python
Response: { chat: { id, title, messages: [...] } }
```

Create endpoint: `POST /api/v1/chat/new`
```python
Response: { chat_id: str }
```

Create endpoint: `DELETE /api/v1/chat/{chat_id}`
```python
Response: { success: bool }
```

**Files to create:**
- `backend/app/api/chat_history.py`
- `backend/app/services/chat_service.py`

**Files to modify:**
- `backend/app/main.py` (register router)
- `backend/app/db/mongodb_client.py` (add chat collection methods)

---

### Phase 3: Chat History Frontend (Priority 2)

**Frontend Work:**
1. Create `ChatHistorySidebar.tsx`
2. Create chat context/state management
3. Integrate "+ New Chat" button
4. Load chat history on mount
5. Save messages to backend after each exchange
6. Switch between chats

**Files to create:**
- `frontend/src/components/ChatHistorySidebar.tsx`
- `frontend/src/contexts/ChatContext.tsx`

**Files to modify:**
- `frontend/src/app/trade/page.tsx` (add sidebar)
- `frontend/src/components/ChatPanel.tsx` (save messages)

---

### Phase 4: Remove Symbol Selector (Priority 3)

**Frontend Work:**
1. Delete `SymbolSelector.tsx`
2. Remove symbol selection from `TradePage.tsx`
3. Update `ChatPanel.tsx` to not send symbol in request
4. Backend already handles natural language symbol detection

**Backend Work:**
- âœ… Already implemented - backend extracts symbols from query

**Files to delete:**
- `frontend/src/components/SymbolSelector.tsx`

**Files to modify:**
- `frontend/src/app/trade/page.tsx` (remove SymbolSelector)
- `frontend/src/components/ChatPanel.tsx` (remove symbol prop)

---

### Phase 5: Update TradingView Chart (Priority 3)

**Frontend Work:**
1. Enable built-in symbol search in TradingView widget
2. Remove hardcoded symbol prop
3. Default to BTC/USDT on load
4. User can search any symbol in chart

**Files to modify:**
- `frontend/src/components/TradingViewChart.tsx`

**Changes:**
```typescript
// Line 39: Change interval to 15
interval: "15",

// Line 52: Enable symbol change
allow_symbol_change: true,

// Remove symbol format conversion (lines 16-27)
// Use default TradingView symbols
```

---

### Phase 6: Error Handling & UX Polish (Priority 4)

**Frontend Work:**
1. Create toast notification system
2. Add loading states to all actions
3. Handle network errors gracefully
4. Add retry logic for failed requests
5. Show user-friendly error messages

**Files to create:**
- `frontend/src/components/ErrorToast.tsx`
- `frontend/src/hooks/useToast.ts`

**Files to modify:**
- All API calling components

---

### Phase 7: Testing & Deployment (Priority 5)

**Testing:**
1. Test auth flow (signup â†’ login â†’ logout â†’ refresh)
2. Test chat history (create â†’ save â†’ load â†’ switch â†’ delete)
3. Test predictions with natural language
4. Test error scenarios
5. Test on mobile/tablet

**Deployment:**
1. Update Vercel environment variables
2. Deploy frontend
3. Update CORS in backend to allow Vercel domain
4. Test production deployment

---

## Critical Files Reference

### Files to Create (17 new files)

**Frontend (12 files):**
1. `frontend/src/contexts/AuthContext.tsx`
2. `frontend/src/contexts/ChatContext.tsx`
3. `frontend/src/lib/api-client.ts`
4. `frontend/src/app/login/page.tsx`
5. `frontend/src/app/signup/page.tsx`
6. `frontend/src/components/ProtectedRoute.tsx`
7. `frontend/src/components/ChatHistorySidebar.tsx`
8. `frontend/src/components/ErrorToast.tsx`
9. `frontend/src/components/Header.tsx`
10. `frontend/src/hooks/useToast.ts`
11. `frontend/src/types/chat.ts`
12. `frontend/src/types/auth.ts`

**Backend (5 files):**
1. `backend/app/api/chat_history.py`
2. `backend/app/services/chat_service.py`
3. `backend/app/models/chat.py`

### Files to Modify (6 files)

**Frontend (5 files):**
1. `frontend/src/app/layout.tsx`
2. `frontend/src/app/trade/page.tsx`
3. `frontend/src/components/ChatPanel.tsx`
4. `frontend/src/components/TradingViewChart.tsx`
5. `frontend/.env.local`

**Backend (1 file):**
1. `backend/app/main.py`

### Files to Delete (1 file)

1. `frontend/src/components/SymbolSelector.tsx`

---

## Backend Endpoints Summary

### Existing (Working)
- âœ… `POST /api/v1/auth/signup`
- âœ… `POST /api/v1/auth/login`
- âœ… `POST /api/v1/auth/refresh`
- âœ… `POST /api/v1/auth/logout`
- âœ… `GET /api/v1/auth/me`
- âœ… `POST /api/v1/predictions` (with natural language symbol detection)

### To Create
- ðŸ†• `POST /api/v1/chat/new` - Create new chat
- ðŸ†• `POST /api/v1/chat/save` - Save message to chat
- ðŸ†• `GET /api/v1/chat/history` - Get all user chats
- ðŸ†• `GET /api/v1/chat/{chat_id}` - Get specific chat with messages
- ðŸ†• `DELETE /api/v1/chat/{chat_id}` - Delete chat
- ðŸ†• `PATCH /api/v1/chat/{chat_id}` - Update chat title

---

## Data Flow Diagrams

### Auth Flow
```
User enters credentials
    â†“
POST /api/v1/auth/login
    â†“
Backend validates (custom JWT auth)
    â†“
Returns { access_token, refresh_token, user }
    â†“
Frontend saves to localStorage
    â†“
AuthContext sets user state
    â†“
Redirect to /trade
    â†“
All API requests include: Authorization: Bearer {token}
    â†“
Token expires after 1 hour
    â†“
Interceptor catches 401
    â†“
POST /api/v1/auth/refresh (with refresh_token)
    â†“
Get new access_token
    â†“
Retry original request
```

### Chat History Flow
```
User clicks "+ New Chat"
    â†“
POST /api/v1/chat/new
    â†“
Backend creates chat in MongoDB
    â†“
Returns { chat_id }
    â†“
Frontend sets currentChat = { id: chat_id, messages: [] }
    â†“
User sends message "analyze BTC"
    â†“
POST /api/v1/predictions { query: "analyze BTC" }
    â†“
Backend: TA Agent â†’ News Agent â†’ Prediction Agent
    â†“
Returns prediction
    â†“
Frontend displays in ChatPanel
    â†“
POST /api/v1/chat/save { chat_id, message, response }
    â†“
Backend saves to MongoDB
    â†“
User clicks chat in sidebar
    â†“
GET /api/v1/chat/{chat_id}
    â†“
Load messages into ChatPanel
```

### Prediction Flow (No Symbol Selector)
```
User types: "What's the outlook for TSLA?"
    â†“
ChatPanel sends: POST /api/v1/predictions { query }
    â†“
Backend LangGraph workflow:
    1. TA Agent extracts symbol from query â†’ "TSLA"
    2. TA Agent analyzes NASDAQ:TSLA technical data
    3. News Agent searches "TSLA stock news"
    4. Prediction Agent synthesizes â†’ BULLISH/BEARISH
    â†“
Returns full prediction object
    â†“
PredictionDisplay renders:
    - Direction, confidence, entry, SL, TPs
    - Technical levels, order blocks
    - TA summary, news impact
```

---

## Error Handling Strategy

### 1. Network Errors
```typescript
// Show toast: "Connection lost. Retrying..."
// Retry 3 times with exponential backoff
// If all fail: "Unable to connect. Please check your internet."
```

### 2. 401 Unauthorized
```typescript
// Interceptor automatically tries to refresh token
// If refresh fails â†’ logout user â†’ redirect to /login
// Show toast: "Session expired. Please login again."
```

### 3. Backend Down (5xx errors)
```typescript
// Show toast: "Service temporarily unavailable. Try again in a moment."
// Disable send button
// Show inline message in chat
```

### 4. Validation Errors (400)
```typescript
// Parse backend error message
// Show inline below input field
// Example: "Email already registered"
```

### 5. Rate Limiting (429)
```typescript
// Show toast: "Too many requests. Please wait 60 seconds."
// Disable send button for countdown
// Show countdown timer
```

---

## Environment Variables

### Frontend (.env.local)
```bash
NEXT_PUBLIC_API_URL=https://your-backend.onrender.com
NEXT_PUBLIC_SUPABASE_URL=https://nxqnlhifrpvgximmuyyl.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbG...
```

### Backend (Render dashboard)
```bash
# Already configured âœ…
MONGODB_URL=mongodb+srv://...
SUPABASE_URL=https://...
SUPABASE_SERVICE_KEY=eyJ...
REDIS_URL=rediss://...
# All other vars already set
```

---

## Success Criteria

### Phase 1 Complete
- [ ] User can signup with email/password
- [ ] User can login and receive JWT tokens
- [ ] Tokens stored in localStorage
- [ ] /trade route protected (redirect if not logged in)
- [ ] Logout works and clears tokens

### Phase 2 Complete
- [ ] New chat endpoint creates chat in MongoDB
- [ ] Save message endpoint stores chat history
- [ ] History endpoint returns list of chats
- [ ] Get chat endpoint loads full conversation

### Phase 3 Complete
- [ ] "+ New Chat" button creates new chat
- [ ] Chat history sidebar shows past chats
- [ ] Click chat loads messages
- [ ] Delete chat removes from sidebar
- [ ] Current chat auto-saves messages

### Phase 4 Complete
- [ ] SymbolSelector deleted
- [ ] ChatPanel accepts any natural language query
- [ ] Backend correctly extracts symbols from queries
- [ ] "analyze BTC", "what about TSLA", "show me AAPL" all work

### Phase 5 Complete
- [ ] TradingView chart has search enabled
- [ ] User can search any symbol in chart
- [ ] Chart displays selected symbol correctly
- [ ] Default symbol loads on page load

### Phase 6 Complete
- [ ] Toast notifications for all errors
- [ ] Loading spinners for all actions
- [ ] Network errors handled gracefully
- [ ] No raw API errors shown to user
- [ ] Retry logic works for failures

### Phase 7 Complete
- [ ] All features tested and working
- [ ] Frontend deployed to Vercel
- [ ] Backend CORS allows Vercel domain
- [ ] Production environment tested
- [ ] No console errors in production

---

## Estimated Timeline

| Phase | Backend Work | Frontend Work | Total Time |
|-------|-------------|---------------|------------|
| Phase 1: Auth | 0h (done) | 4h | 4h |
| Phase 2: Chat Backend | 3h | 0h | 3h |
| Phase 3: Chat Frontend | 0h | 5h | 5h |
| Phase 4: Remove Selector | 0h | 1h | 1h |
| Phase 5: Chart Update | 0h | 1h | 1h |
| Phase 6: Error Handling | 0h | 3h | 3h |
| Phase 7: Testing | 1h | 2h | 3h |
| **Total** | **4h** | **16h** | **20h** |

---

## Next Steps

1. Review this plan
2. Approve or request changes
3. Start with Phase 1 (Auth system)
4. Test each phase before moving to next
5. Deploy after Phase 7 complete

